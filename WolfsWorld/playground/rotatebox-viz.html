<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suchbaum Visualisierung v2.0</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/tree-viz.css">
    
    <style>
        /* Override für Full-Screen Layout */
        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
            background: #f0f3f4;
        }
        
        /* Iframe container */
        .viz-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #vizFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>

    <div class="viz-toolbar">
        <a href="../index.html" class="viz-btn btn-back">⬅ Menü</a>
        
        <div class="viz-control-group">
            <label class="viz-label">Level</label>
            <select id="levelSelect" class="viz-select">
                <option value="0">Tutorial</option>
                <option value="1">Level 1 (Einfach)</option>
                <option value="2">Level 2 (Mittel)</option>
                <option value="3">Level 3 (Komplex)</option>
            </select>
        </div>

        <div class="viz-control-group">
            <label class="viz-label">Tiefe</label>
            <input type="number" id="depthInput" value="4" min="1" max="15" class="viz-input" style="width: 60px;">
        </div>

        <div class="viz-control-group">
            <label class="viz-label">Algo</label>
            <select id="algoSelect" class="viz-select">
                <option value="BFS">Breitensuche (BFS)</option>
                <option value="DFS">Tiefensuche (DFS)</option>
            </select>
        </div>

        <div class="viz-checkboxes">
            <label class="viz-checkbox-label">
                <input type="checkbox" id="chkDuplicates"> Duplikate markieren
            </label>
        </div>

        <div id="stats" class="viz-stats">Bereit.</div>
    </div>

    <div class="viz-container">
        <iframe id="vizFrame" src="tree-viz-v2.html?v=2.3&autoFitZoom=true"></iframe>
    </div>

    <!-- RotateBoard Logic -->
    <script src="../js/games/rotatebox/logic.js"></script>
    
    <!-- Tree Adapters -->
    <script src="../js/adapters/bfs-tree-adapter.js"></script>
    <script src="../js/adapters/dfs-tree-adapter.js"></script>

    <script>
        // URL-Parameter auslesen
        const urlParams = new URLSearchParams(window.location.search);
        
        // Pass parameters to inner iframe
        const innerFrame = document.getElementById('vizFrame');
        let src = innerFrame.getAttribute('src');
        if (urlParams.has('autoFitZoom')) src += `&autoFitZoom=${urlParams.get('autoFitZoom')}`;
        if (urlParams.has('showOverlay')) src += `&showOverlay=${urlParams.get('showOverlay')}`;
        innerFrame.src = src;

        // Adapter instances
        const iframe = document.getElementById('vizFrame');
        let bfsAdapter = null;
        let dfsAdapter = null;
        
        function initAdapters() {
            if (!bfsAdapter) bfsAdapter = new BFSTreeAdapter(iframe);
            if (!dfsAdapter) dfsAdapter = new DFSTreeAdapter(iframe);
            console.log('Playground: Adapters initialisiert');
        }
        
        // Warten bis iframe geladen ist
        iframe.addEventListener('load', () => {
            initAdapters();
            setTimeout(buildCurrentTree, 300);
        });
        
        // Listen for messages from parent (Learning Path)
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'UPDATE_PARAMS') {
                const p = event.data;
                console.log('RotateBoxViz: Received update', p);
                
                // Update UI controls
                if (p.level !== undefined) document.getElementById('levelSelect').value = p.level;
                if (p.maxDepth !== undefined) document.getElementById('depthInput').value = p.maxDepth;
                if (p.duplicates !== undefined) document.getElementById('chkDuplicates').checked = p.duplicates;
                if (p.algorithm !== undefined) document.getElementById('algoSelect').value = p.algorithm;
                
                // Rebuild tree
                updateTree();
            }
        });
        
        // Fallback: Auch beim Fenster-Laden probieren
        window.addEventListener('load', () => {
            initAdapters();
            setTimeout(buildCurrentTree, 500);
        });

        /**
         * Hilfsfunktion: Baut den Baum mit Retry-Logik.
         */
        function buildCurrentTree() {
            initAdapters(); 
            const algo = document.getElementById('algoSelect').value;
            const adapter = (algo === 'DFS') ? dfsAdapter : bfsAdapter;

            if (!adapter || !adapter.ready) {
                console.log('Playground: Warte auf Adapter ready...');
                setTimeout(buildCurrentTree, 100);
                return;
            }
            
            updateTree();
        }

        /**
         * Wird beim Klick auf "Generieren" aufgerufen.
         */
        function updateTree() {
            // 1. UI Werte lesen
            const levelId = document.getElementById('levelSelect').value;
            const maxDepth = parseInt(document.getElementById('depthInput').value);
            const checkDuplicates = document.getElementById('chkDuplicates').checked;
            const algo = document.getElementById('algoSelect').value;
            
            // Choose provider
            const adapter = (algo === 'DFS') ? dfsAdapter : bfsAdapter;

            if (!adapter || !adapter.ready) {
                console.warn('Playground: Adapter noch nicht bereit');
                return;
            }
            
            // 2. Startzustand laden
            const startBoard = new RotateBoard(levelId);
            
            // 3. Adapter zurücksetzen (wichtig für Duplikate-Erkennung)
            adapter.nodeMap.clear();
            adapter.nodeIdCounter = 0;
            adapter.sendCommand({ action: 'CLEAR' });
            
            // 4. Baum generieren über Adapter
            console.log(`Generating tree using ${algo}...`);
            const startTime = performance.now();
            
            adapter.buildToDepth(startBoard, maxDepth, {
                duplicates: checkDuplicates
            });
            
            const endTime = performance.now();
            
            // 5. Statistik
            const nodeCount = adapter.getNodeCount ? adapter.getNodeCount() : adapter.nodeIdCounter;
            document.getElementById('stats').innerText = 
                `Nodes: ${nodeCount} | Time: ${(endTime - startTime).toFixed(1)}ms | Algo: ${algo}`;
            
            console.log(`Playground: Baum generiert (${algo}) - ${nodeCount} Nodes`);
        }


        // URL-Parameter verarbeiten beim Laden
        window.addEventListener('load', function() {
            // Toolbar Controls verstecken falls hideControls=true
            const hideControls = urlParams.get('hideControls') === 'true';
            if (hideControls) {
                document.querySelector('.viz-toolbar').style.display = 'none';
            }
            
            // Einzelne Controls verstecken
            const showLevelSelect = urlParams.get('showLevelSelect') !== 'false';
            const showDuplicateToggle = urlParams.get('showDuplicateToggle') !== 'false';
            const showAlgoSelect = urlParams.get('showAlgoSelect') !== 'false';
            
            if (!showLevelSelect) {
                document.querySelector('#levelSelect').closest('.viz-control-group').style.display = 'none';
            }
            if (!showDuplicateToggle) {
                document.querySelector('#chkDuplicates').closest('.viz-checkbox-label').style.display = 'none';
            }
            if (!showAlgoSelect) {
                document.querySelector('#algoSelect').closest('.viz-control-group').style.display = 'none';
            }
            
            // Parameter-basierte Defaults setzen
            if (urlParams.has('level')) {
                document.getElementById('levelSelect').value = urlParams.get('level');
            }
            if (urlParams.has('maxDepth')) {
                document.getElementById('depthInput').value = urlParams.get('maxDepth');
            }
            if (urlParams.has('duplicates')) {
                document.getElementById('chkDuplicates').checked = urlParams.get('duplicates') === 'true';
            }
            if (urlParams.has('algorithm')) {
                document.getElementById('algoSelect').value = urlParams.get('algorithm');
            }
            
            // Event Listener für automatische Updates bei ALLEN Änderungen
            document.getElementById('levelSelect').addEventListener('change', updateTree);
            document.getElementById('depthInput').addEventListener('change', updateTree);
            document.getElementById('chkDuplicates').addEventListener('change', updateTree);
            document.getElementById('algoSelect').addEventListener('change', updateTree);
        });
    </script>
</body>
</html>