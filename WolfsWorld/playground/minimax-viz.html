<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimax Algorithmus Visualisierung</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/tree-viz.css">
    
    <style>
        /* General Layout */
        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            background: #f0f3f4; 
        }
        
        .nav-header { 
            background: #2c3e50; 
            color: white; 
            padding: 0 20px; 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            height: 50px; 
            flex-shrink: 0; 
        }
        .nav-header h1 { 
            margin: 0; 
            font-size: 1.2rem; 
            font-weight: normal; 
        }
        .btn-back { 
            text-decoration: none; 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3); 
            padding: 5px 10px; 
            border-radius: 4px; 
            font-size: 0.9rem; 
        }
        .btn-back:hover { 
            background: rgba(255,255,255,0.1); 
        }

        /* Toolbar */
        .viz-toolbar { 
            background: white; 
            padding: 10px 20px; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            gap: 20px; 
            align-items: center; 
            flex-wrap: wrap; 
            flex-shrink: 0; 
            justify-content: space-between; 
        }
        .toolbar-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .viz-select, .viz-input { 
            padding: 6px; 
            border: 1px solid #bdc3c7; 
            border-radius: 4px; 
            font-size: 0.95rem; 
        }
        .viz-label { 
            font-size: 0.9rem; 
            font-weight: 600; 
            color: #34495e; 
        }
        .viz-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
            font-weight: 500;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        
        #stats {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
        }

        /* Split View */
        .split-container { 
            flex: 1; 
            display: flex; 
            min-height: 0; 
        }
        .tree-pane { 
            flex: 1; 
            border-right: 1px solid #bdc3c7; 
            background: #fff; 
            position: relative; 
        }
        .board-pane { 
            width: 450px; 
            background: #ecf0f1; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            overflow-y: auto; 
            align-items: center; 
            padding: 20px; 
        }
        
        #vizFrame { 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        
        /* Board Area */
        .board-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }

        .board-container {
            width: 100%;
            aspect-ratio: 1;
            position: relative;
        }

        canvas { 
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 4px;
            cursor: pointer;
        }

        .board-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 0.95rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .info-value {
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        .board-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="nav-header">
        <a href="../index.html" class="btn-back">â¬… MenÃ¼</a>
        <h1>Minimax Algorithmus Visualisierung</h1>
    </div>

    <!-- Toolbar -->
    <div class="viz-toolbar">
        <div class="toolbar-group">
            <label class="viz-label">Spiel</label>
            <select id="gameSelect" class="viz-select">
                <option value="regular">TicTacToe 3x3</option>
                <option value="3d">TicTacToe 3D</option>
            </select>
        </div>

        <div class="toolbar-group">
            <label class="viz-label">Algorithmus</label>
            <select id="algoSelect" class="viz-select">
                <option value="minimax">Minimax (Standard)</option>
                <option value="alphabeta">Alpha-Beta Pruning</option>
                <option value="limited">Tiefenbegrenzung</option>
            </select>
        </div>

        <div class="toolbar-group">
            <label class="viz-label">Max. Tiefe</label>
            <input type="number" id="depthInput" value="2" min="1" max="9" class="viz-input" style="width: 60px;">
        </div>

        <div class="toolbar-group">
            <button id="btnNewGame" class="viz-btn btn-primary">ðŸ”„ Neues Spiel</button>
            <button id="btnReset" class="viz-btn btn-secondary">ðŸ—‘ Baum lÃ¶schen</button>
        </div>

        <div id="stats">Bereit. Klicke auf das Board um zu spielen.</div>
    </div>

    <!-- Split Container -->
    <div class="split-container">
        <!-- Tree Pane (Left) -->
        <div class="tree-pane">
            <iframe id="vizFrame" src="tree-viz-v2.html?v=2.3&autoFitZoom=false"></iframe>
        </div>

        <!-- Board Pane (Right) -->
        <div class="board-pane">
            <div class="board-card">
                <h3 style="margin: 0; text-align: center; color: #2c3e50;">Spielbrett</h3>
                
                <div class="board-container">
                    <canvas id="boardCanvas" width="400" height="400"></canvas>
                </div>

                <div class="board-info">
                    <div class="info-row">
                        <span class="info-label">Aktueller Spieler:</span>
                        <span class="info-value" id="currentPlayer">X</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ZÃ¼ge:</span>
                        <span class="info-value" id="moveCount">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="gameStatus">Laufend</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Bewertung:</span>
                        <span class="info-value" id="evaluation">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Game Logic -->
    <script src="../js/games/tictactoe/logic.js"></script>
    <script src="../js/games/tictactoe/renderer.js"></script>
    
    <!-- AI -->
    <script src="../js/ai/heuristics.js"></script>
    <script src="../js/ai/minimax.js"></script>
    
    <!-- Tree Visualization Utilities -->
    <script src="../js/viz/tree-viz/utils/node-status-manager.js"></script>
    
    <!-- Tree Adapter -->
    <script src="../js/viz/adapters/tree-adapters/minimax-tree-adapter.js"></script>

    <script>
        /**
         * @fileoverview Minimax Visualisierung - Hauptlogik
         * Verbindet TicTacToe Board mit Minimax Tree Visualisierung
         */

        // ============================================================================
        // GLOBALS
        // ============================================================================
        const canvas = document.getElementById('boardCanvas');
        const ctx = canvas.getContext('2d');
        const iframe = document.getElementById('vizFrame');
        
        let adapter = null;
        let currentBoard = null;
        let gameType = 'regular';

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        /**
         * Initialisiert die Visualisierung beim Laden
         */
        function init() {
            // Create adapter
            adapter = new MinimaxTreeAdapter(iframe);
            
            // Initialize board
            resetBoard();
            
            // Setup event listeners
            setupEventListeners();
            
            console.log('Minimax-Viz: Initialized');
        }

        /**
         * Setzt das Board auf Startzustand zurÃ¼ck
         */
        function resetBoard() {
            gameType = document.getElementById('gameSelect').value;
            
            if (gameType === 'regular') {
                currentBoard = new TTTRegularBoard();
                canvas.width = 400;
                canvas.height = 400;
            } else {
                // 3D TicTacToe - TODO: Implementierung spÃ¤ter
                currentBoard = new TTTRegularBoard(); // Fallback
                canvas.width = 400;
                canvas.height = 400;
            }
            
            drawBoard();
            updateBoardInfo();
        }

        /**
         * Zeichnet das aktuelle Board
         */
        function drawBoard() {
            if (gameType === 'regular') {
                TTTRenderer.drawRegular(canvas, currentBoard);
            } else {
                // 3D rendering spÃ¤ter
                TTTRenderer.drawRegular(canvas, currentBoard);
            }
        }

        /**
         * Aktualisiert die Board-Informationen
         */
        function updateBoardInfo() {
            const player = currentBoard.currentPlayer === 1 ? 'X' : 'O';
            document.getElementById('currentPlayer').textContent = player;
            
            const moveCount = currentBoard.grid.filter(x => x !== 0).length;
            document.getElementById('moveCount').textContent = moveCount;
            
            const winner = currentBoard.winner;
            let status = 'Laufend';
            if (winner === 1) status = 'X gewinnt';
            else if (winner === 2) status = 'O gewinnt';
            else if (winner === 3) status = 'Unentschieden';
            document.getElementById('gameStatus').textContent = status;
            
            // Evaluation (winner property: 0=laufend, 1=X, 2=O, 3=unentschieden)
            const eval = winner === 1 ? '+1' : winner === 2 ? '-1' : '0';
            document.getElementById('evaluation').textContent = eval;
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================
        
        /**
         * Setzt alle Event Listeners
         */
        function setupEventListeners() {
            // Canvas click
            canvas.addEventListener('click', handleBoardClick);
            
            // Button clicks
            document.getElementById('btnReset').addEventListener('click', resetVisualization);
            document.getElementById('btnNewGame').addEventListener('click', resetBoard);
            
            // Game type change
            document.getElementById('gameSelect').addEventListener('change', resetBoard);
            
            // Algorithm/Depth change - trigger re-visualization if game is active
            document.getElementById('algoSelect').addEventListener('change', () => {
                if (currentBoard && currentBoard.winner === 0) {
                    visualizeMinimax();
                }
            });
            document.getElementById('depthInput').addEventListener('change', () => {
                if (currentBoard && currentBoard.winner === 0) {
                    visualizeMinimax();
                }
            });
            
            // Iframe load
            iframe.addEventListener('load', () => {
                console.log('Minimax-Viz: Tree iframe loaded');
            });
        }

        /**
         * Behandelt Klicks auf das Spielbrett
         * @param {MouseEvent} e
         */
        function handleBoardClick(e) {
            if (currentBoard.winner !== 0) {
                document.getElementById('stats').textContent = 'Spiel beendet. Klicke "Neues Spiel" zum Neustart.';
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            
            // Scale to canvas coordinates
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const canvasX = mx * scaleX;
            const canvasY = my * scaleY;
            
            const move = coordsToMove(canvasX, canvasY);
            
            // Check if move is valid: must be in valid moves list
            const validMoves = currentBoard.getAllValidMoves();
            if (move !== null && validMoves.includes(move)) {
                // makeMove modifies board in-place and returns boolean
                const success = currentBoard.makeMove(move);
                if (success) {
                    drawBoard();
                    updateBoardInfo();
                    
                    console.log('Move played:', move);
                    
                    // LIVE VISUALIZATION: Trigger tree update after move
                    if (currentBoard.winner === 0) {
                        visualizeMinimax();
                    }
                }
            }
        }

        /**
         * Konvertiert Canvas-Koordinaten zu Zug-Index
         * @param {number} mx
         * @param {number} my
         * @returns {number|null}
         */
        function coordsToMove(mx, my) {
            if (gameType === 'regular') {
                const s = canvas.width / 3;
                const c = Math.floor(mx / s);
                const r = Math.floor(my / s);
                
                if (c >= 0 && c < 3 && r >= 0 && r < 3) {
                    return r * 3 + c;
                }
            }
            return null;
        }

        /**
         * Startet Minimax-Visualisierung (LIVE nach jedem Zug)
         */
        async function visualizeMinimax() {
            if (!adapter || !adapter.ready) {
                console.warn('Adapter not ready yet, retrying...');
                setTimeout(visualizeMinimax, 100);
                return;
            }
            const algo = document.getElementById('algoSelect').value;
            const maxDepth = parseInt(document.getElementById('depthInput').value);
            document.getElementById('stats').textContent = 'Berechne Minimax-Baum...';
            try {
                const startTime = performance.now();
                const result = await adapter.visualizeSearch(currentBoard, {
                    algorithm: algo,
                    maxDepth: maxDepth,
                    stepMode: false
                });
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(1);
                document.getElementById('stats').textContent = 
                    `Knoten: ${result.nodesVisited} | Geprunt: ${result.nodesPruned || 0} | Zeit: ${duration}ms | Beste Bewertung: ${result.bestValue}`;
                console.log('Minimax visualization complete:', result);
            } catch (err) {
                console.error('Visualization error:', err);
                document.getElementById('stats').textContent = 'Fehler: ' + err.message;
            }
        }

        /**
         * Setzt die Visualisierung zurÃ¼ck
         */
        function resetVisualization() {
            if (adapter && adapter.ready) {
                adapter.sendCommand({ action: 'CLEAR' });
            }
            document.getElementById('stats').textContent = 'Baum gelÃ¶scht. Klicke auf das Board um zu spielen.';
        }

        // ==================================================aum gelÃ¶scht. Klicke auf das Board um zu spielen=====================
        // STARTUP
        // ============================================================================
        
        // Initialize when iframe is loaded
        iframe.addEventListener('load', init);
        
        // Fallback: Also try on window load
        window.addEventListener('load', () => {
            if (!adapter) init();
        });
    </script>
</body>
</html>
