<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suchbaum Visualisierung</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/tree-viz.css">
    
    <style>
        /* Override für Full-Screen Layout */
        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
            background: #f0f3f4;
        }
    </style>
</head>
<body>

    <div class="viz-toolbar">
        <a href="../index.html" class="viz-btn btn-back">⬅ Menü</a>
        
        <div class="viz-control-group">
            <label class="viz-label">Level</label>
            <select id="levelSelect" class="viz-select">
                <option value="0">Tutorial</option>
                <option value="1">Level 1 (Einfach)</option>
                <option value="2">Level 2 (Mittel)</option>
                <option value="3">Level 3 (Komplex)</option>
            </select>
        </div>

        <div class="viz-control-group">
            <label class="viz-label">Tiefe</label>
            <input type="number" id="depthInput" value="4" min="1" max="15" class="viz-input" style="width: 60px;">
        </div>

        <div class="viz-control-group">
            <label class="viz-label">Algo</label>
            <select id="algoSelect" class="viz-select">
                <option value="BFS">Breitensuche (BFS)</option>
                <option value="DFS">Tiefensuche (DFS)</option>
            </select>
        </div>

        <div class="viz-checkboxes">
            <label class="viz-checkbox-label">
                <input type="checkbox" id="chkDuplicates" checked> Duplikate markieren
            </label>
            <label class="viz-checkbox-label">
                <input type="checkbox" id="chkContinueSol"> Nach Ziel weiter
            </label>
            <button class="viz-btn btn-action" onclick="updateTree()">Baum generieren</button>
        </div>

        <div id="stats" class="viz-stats">Bereit.</div>

        
    </div>

    <div class="viz-container">
        <canvas id="treeCanvas" class="viz-canvas"></canvas>
    </div>

    <script src="../js/core/game-state.js"></script>
    
    <script src="../js/games/rotatebox/logic.js"></script>
    
    <script src="../js/viz/tree-engine.js"></script>
    <script src="../js/games/rotatebox/tree-adapter.js"></script>

    <script>
        // Visualisierer initialisieren
        const viz = new TreeVisualizer('treeCanvas');

        /**
         * Hilfsfunktion: Zeichnet das Board kompakt in den Node.
         * Zeichnet einfache Rechtecke statt der aufwändigen Grafik des Hauptspiels,
         * um Performance zu sparen und bei kleinen Nodes lesbar zu bleiben.
         */
        function drawCompactBoard(ctx, board, size) {
            const COLORS = ['#e74c3c', '#2ecc71', '#f1c40f', '#3498db', '#e67e22'];
            
            const maxDim = Math.max(board.rows, board.cols);
            if (maxDim === 0) return;
            
            // Blockgröße berechnen
            const bs = size / maxDim; 
            const ox = (size - (board.cols * bs)) / 2;
            const oy = (size - (board.rows * bs)) / 2;

            for (let r = 0; r < board.rows; r++) {
                for (let c = 0; c < board.cols; c++) {
                    const v = board.grid[r][c];
                    const x = ox + c * bs;
                    const y = oy + r * bs;
                    
                    if (v === -2) { // Wand
                        ctx.fillStyle = '#2c3e50'; 
                        ctx.fillRect(x, y, bs, bs); 
                    } else if (v === -3) { // Ziel
                        ctx.fillStyle = '#ecf0f1';
                        ctx.fillRect(x, y, bs, bs);
                        ctx.strokeStyle = '#e74c3c'; 
                        ctx.lineWidth = 2; 
                        ctx.strokeRect(x+1, y+1, bs-2, bs-2);
                    } else if (v >= 0) { // Box
                        ctx.fillStyle = COLORS[v % COLORS.length];
                        ctx.fillRect(x+1, y+1, bs-2, bs-2);
                    }
                }
            }
        }

        /**
         * Wird beim Klick auf "Generieren" aufgerufen.
         */
        function updateTree() {
            // 1. UI Werte lesen
            const levelId = document.getElementById('levelSelect').value;
            const options = {
                maxDepth: parseInt(document.getElementById('depthInput').value),
                algorithm: document.getElementById('algoSelect').value,
                checkDuplicates: document.getElementById('chkDuplicates').checked,
                continueAfterSolution: document.getElementById('chkContinueSol').checked
            };

            // 2. Startzustand laden
            const startBoard = new RotateBoard(levelId); // Nutzt logic.js
            
            // 3. Baum generieren (Adapter)
            const root = RotateBoxAdapter.generateTree(startBoard, options);

            // 4. Statistik (Nodes zählen)
            let count = 0;
            const countNodes = (n) => { count++; n.children.forEach(countNodes); };
            countNodes(root);
            document.getElementById('stats').innerText = `Nodes: ${count}`;

            // 5. Zeichnen (Engine)
            viz.drawTree(root, { 
                drawNodeFn: drawCompactBoard,
                config: { nodePadding: 2 } 
            });
        }

        // Starten beim Laden
        window.onload = updateTree;
    </script>
</body>
</html>